<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ប្រព័ន្ធស្កេនមុខឌីជីថល</title>
  <link rel="icon" href="https://img.freepik.com/premium-vector/face-scan-icon_933463-79729.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Moul&display=swap');
    body { font-family: 'Kantumruy Pro', sans-serif; background:#0f172a; color:#e2e8f0; overflow-y:auto; overflow-x:hidden; }
    .main-content { background: rgba(30,41,59,.7); border:1px solid rgba(255,255,255,.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    #sidebar { transition: transform .3s ease-in-out; }
    #sidebar.is-open { transform: translateX(0); }
    .nav-link.active { background:#4f46e5; color:#fff; box-shadow:0 4px 14px rgba(79,70,229,.39) }
    .video-container video { position:absolute; top:50%; left:50%; width:100%; height:100%; object-fit:cover; transform:translate(-50%,-50%); /* removed mirror */ }
    .video-container { position:relative; border-radius:50%; overflow:hidden; border:5px solid transparent; transition:all .4s ease; box-shadow:0 0 15px rgba(0,0,0,.5); }
    .video-container.ready { border-color:#4ade80; box-shadow:0 0 25px rgba(74,222,128,.6); }
    .video-container.fail { border-color:#f43f5e; box-shadow:0 0 25px rgba(244,63,94,.6); }
    .scanner-line { position:absolute; left:0; width:100%; height:3px; background:linear-gradient(to right,transparent,#4ade80,transparent); box-shadow:0 0 10px #4ade80; animation:scan 3s linear infinite; opacity:0; transition:opacity .3s; }
    .video-container.ready .scanner-line { opacity:1; }
    @keyframes scan { 0%{top:0%} 50%{top:100%} 100%{top:0%} }
    .modal { background: rgba(15,23,42,.8); backdrop-filter: blur(5px); }
    .modal-content { background:#1e293b; border:1px solid #475569; }
    .khmer-title { font-family:"Moul", serif; }
    .table-container { height: calc(100vh - 280px); overflow-y:auto; }
    #student-list { max-height:40vh; overflow-y:auto; }
    #student-list li:hover { background-color:#334155; }
    #student-list li.completed { color:#4ade80!important; font-weight:600; opacity:.7; pointer-events:none; }
    .filter-select{
      background-color:#E5E7EB; color:#111827; padding:.5rem 2rem .5rem .75rem; font-size:.875rem; border-radius:.5rem; border:1px solid #9CA3AF; -webkit-appearance:none; appearance:none;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position:right .5rem center; background-repeat:no-repeat; background-size:1.5em 1.5em;
    }
    .filter-select option{ background:#F3F4F6; color:#000; }
    @media (min-width:768px){ .filter-select{ padding:.6rem 2.5rem .6rem 1rem; font-size:1rem; } }
    ::-webkit-scrollbar{ width:8px; height:8px; }
    ::-webkit-scrollbar-track{ background:#1e293b; }
    ::-webkit-scrollbar-thumb{ background:#475569; border-radius:4px; }

    /* Login card */
    #login-screen{ min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem; }
    .login-card{ width:100%; max-width:400px; background:rgba(30,41,59,.7); border:1px solid rgba(255,255,255,.1); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-radius:1.5rem; padding:2rem; box-shadow:0 20px 50px rgba(0,0,0,.3); }
    #admin-select{ background-color:#334155; color:#e2e8f0; border:1px solid #475569; }
  </style>
</head>

<body class="bg-slate-900 text-slate-200">

  <!-- LOGIN -->
  <div id="login-screen">
    <div class="login-card text-center">
      <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="w-24 h-24 rounded-full mx-auto mb-4 shadow-lg">
      <h1 id="login-title" class="text-2xl font-bold text-white khmer-title mb-2">ចូលគណនី</h1>
      <p id="login-subtitle" class="text-slate-400 mb-6">សូមជ្រើសរើសឈ្មោះរបស់អ្នក</p>

      <div id="admin-selection-area">
        <div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin mx-auto mb-4" id="admin-list-loader"></div>
        <select id="admin-select" class="hidden filter-select w-full text-base mb-4 py-3 px-4" style="background-position: right 1rem center;">
          <option value="">-- Select Your Name --</option>
        </select>
        <button id="proceed-to-scan-btn" class="hidden w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition shadow-lg">
          បន្តទៅការស្កេន
        </button>
      </div>

      <div id="admin-scan-area" class="hidden flex flex-col items-center space-y-4">
        <div id="admin-video-wrapper" class="video-container w-[90%] mx-auto aspect-square">
          <video id="admin-video" autoplay muted playsinline></video>
        </div>
        <canvas id="admin-canvas" class="hidden"></canvas>
        <p id="admin-scan-status" class="text-center text-sm h-10 font-semibold text-slate-400"></p>

        <div class="flex flex-col w-full space-y-3">
          <button id="admin-manual-scan-btn" class="w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition">
            <i class="fas fa-camera mr-2"></i> ស្កេនដោយខ្លួនឯង
          </button>
          <button id="admin-back-btn" class="w-full text-slate-400 py-2 rounded-xl font-semibold hover:text-white transition">
            <i class="fas fa-arrow-left mr-2"></i> ត្រលប់​ក្រោយ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="main-app-wrapper" class="hidden">
    <div class="relative min-h-screen md:flex">
      <div id="sidebar-backdrop" class="hidden md:hidden fixed inset-0 bg-black/50 z-30"></div>

      <!-- SIDEBAR -->
      <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-slate-800/80 backdrop-blur-lg z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
        <div class="text-center py-6 mb-4">
          <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="w-20 h-20 rounded-full mx-auto mb-2 shadow-lg">
          <h2 class="text-xl font-bold text-white khmer-title">ឧស្សាហកម្មឌីជីថល</h2>
        </div>

        <ul class="flex-1 flex flex-col space-y-2 px-4 overflow-y-auto">
          <li><a href="#" id="nav-scan" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-camera-retro fa-fw"></i><span class="font-semibold">ថតរូប</span></a></li>
          <li><a href="#" id="nav-list" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-users fa-fw"></i><span class="font-semibold">ទិន្នន័យរូបភាពនិស្សិត</span></a></li>
          <li><a href="#" id="nav-records" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-database fa-fw"></i><span class="font-semibold">រូបភាពបានរក្សាទុក</span></a></li>
          <li><a href="#" id="nav-history" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-chart-line fa-fw"></i><span class="font-semibold">History & Analytics</span></a></li>
          <li><a href="#" id="nav-storage" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white"><i class="fas fa-link fa-fw"></i><span class="font-semibold">Storage Links</span></a></li>
        </ul>

        <div id="sidebar-profile-btn" class="p-4 border-t border-slate-700/50">
          <button id="open-profile-btn" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-700/50">
            <img id="sidebar-profile-img" class="w-8 h-8 rounded-full" src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Admin" crossorigin="anonymous">
            <div class="text-left flex-1">
              <div id="sidebar-profile-name" class="font-semibold text-white">Not signed</div>
              <div id="sidebar-profile-role" class="text-xs text-slate-400">Role: -</div>
            </div>
            <i class="fas fa-user-cog text-slate-400"></i>
          </button>
        </div>

        <div id="admin-profile-sidebar" class="hidden p-4 border-t border-slate-700/50">
          <div class="flex items-center gap-3">
            <img id="admin-profile-img-sidebar" class="w-10 h-10 rounded-full" src="" alt="Admin" crossorigin="anonymous">
            <div>
              <p id="admin-name-sidebar" class="font-semibold text-white">ឈ្មោះគណនី</p>
              <a href="#" id="logout-btn" class="text-sm text-red-400 hover:text-red-300">Logout</a>
            </div>
          </div>
        </div>

        <footer class="p-4 border-t border-slate-700/50 text-slate-400 text-sm">
          <div class="flex flex-col items-center sm:flex-row sm:justify-between gap-2">
            <p class="text-center sm:text-left">&copy; 2025 IT Support</p>
          </div>
        </footer>
      </aside>

      <!-- CONTENT -->
      <div id="content-wrapper" class="flex flex-col flex-1 md:ml-64 transition-all duration-300 ease-in-out">
        <header class="w-full h-16 bg-slate-800/50 backdrop-blur-lg flex-shrink-0 flex items-center px-6 sticky top-0 z-20">
          <button id="menu-btn" class="text-white mr-4"><i class="fas fa-bars text-xl"></i></button>
          <h1 class="text-xl font-bold text-white khmer-title">គ្រប់គ្រងទិន្នន័យរូបភាព</h1>
          <img id="admin-profile-img-header" class="w-10 h-10 rounded-full ml-auto hidden" src="" alt="Admin" crossorigin="anonymous">
        </header>

        <main class="w-full flex-1 p-4 md:p-8">
          <!-- PAGE: SCAN -->
          <div id="page-scan">
            <div class="main-content rounded-2xl p-6">
              <div class="container w-full max-w-md mx-auto relative">
                <button id="back-btn" class="hidden absolute -top-2 -left-2 w-10 h-10 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition z-20" title="Back to Selection"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-center text-2xl mb-2 text-white khmer-title">ប្រព័ន្ធស្កេនមុខឌីជីថល</h1>
                <p id="subtitle" class="text-center text-slate-400 mb-6">សូមជ្រើសរើសអត្តលេខរបស់អ្នក</p>

                <div id="selection-area" class="mb-5">
                  <input type="text" id="student-search-input" placeholder="ស្វែងរកអត្តលេខ ឬឈ្មោះ..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                  <ul id="student-list" class="space-y-1">
                    <li class="text-center text-slate-400 p-4">Loading students...</li>
                  </ul>
                </div>

                <div id="camera-section" class="hidden flex flex-col items-center space-y-4">
                  <div id="video-wrapper" class="video-container w-[90%] mx-auto aspect-square">
                    <video id="video" autoplay muted playsinline></video>
                    <div class="scanner-line"></div>
                  </div>
                  <div class="flex items-center justify-center gap-4">
                    <button id="switch-camera-btn" class="w-14 h-14 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition" title="Switch Camera"><i class="fas fa-sync-alt fa-lg"></i></button>
                    <button id="manual-capture-btn" class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white hover:bg-indigo-700 transition shadow-lg" title="Capture Photo"><i class="fas fa-camera fa-2x"></i></button>
                  </div>
                  <canvas id="capture-canvas" class="hidden"></canvas>
                  <img id="photo-preview" class="hidden w-[90%] mx-auto aspect-square rounded-full border-4 border-green-400 object-cover shadow-lg">
                  <p id="face-status" class="text-center text-sm h-5 font-semibold text-slate-400"></p>
                  <div class="flex flex-col w-full space-y-3">
                    <button id="upload-btn" class="hidden w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">បញ្ជូនរូបភាព</button>
                    <button id="retake-btn" class="hidden w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition">ថតម្តងទៀត</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- PAGE: LIST -->
          <div id="page-list" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              <h1 class="text-2xl text-white khmer-title">ទិន្នន័យរូបភាពនិស្សិត</h1>
              <div class="flex gap-4 w-full md:w-auto">
                <input type="text" id="list-search-input" placeholder="ស្វែងរកអត្តលេខឬឈ្មោះ..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <select id="list-class-filter" class="filter-select w-full md:w-auto"></select>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-left">
              <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-users fa-2x text-slate-400"></i><div><p class="text-slate-400">ចំនួននិស្សិតសរុប</p><p id="list-total-count" class="text-2xl font-bold text-white">-</p></div></div>
              <div class="bg-green-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-check fa-2x text-green-400"></i><div><p class="text-green-400">និស្សិតមានរូបភាព</p><p id="list-completed-count" class="text-2xl font-bold text-green-400">-</p></div></div>
              <div class="bg-red-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-clock fa-2x text-red-400"></i><div><p class="text-red-400">និស្សិតគ្មានរូបភាព</p><p id="list-pending-count" class="text-2xl font-bold text-red-400">-</p></div></div>
            </div>
            <div id="list-container" class="table-container flex-1 overflow-x-auto">
              <div id="list-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញទិន្នន័យរូបភាពនិស្សិត...</p></div>
              <table id="list-table" class="hidden w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ID</th><th class="p-3">ឈ្មោះ</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">Status</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- PAGE: RECORDS -->
          <div id="page-records" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
              <h1 class="text-2xl text-white khmer-title">រូបភាពបានរក្សាទុក</h1>
              <div class="flex gap-4 w-full md:w-auto">
                <input type="text" id="records-search-input" placeholder="Search ID or Name..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2">
                <select id="records-class-filter" class="filter-select w-full md:w-auto"></select>
              </div>
            </div>
            <div id="records-container" class="table-container flex-1 overflow-x-auto">
              <div id="records-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញរូបភាពបានរក្សាទុក...</p></div>
              <table id="records-table" class="hidden w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ល.រ</th><th class="p-3">ឈ្មោះ</th><th class="p-3">ID</th><th class="p-3">ថ្នាក់</th><th class="p-3">ក្រុម</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">កែ</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- PAGE: HISTORY & ANALYTICS -->
          <div id="page-history" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <div class="flex items-center justify-between mb-4 gap-4">
              <h1 class="text-2xl text-white khmer-title">History & Analytics</h1>
              <div class="flex gap-2 items-center">
                <input type="date" id="history-start" class="filter-select p-2" />
                <input type="date" id="history-end" class="filter-select p-2" />
                <select id="history-admin-filter" class="filter-select p-2"><option value="all">All Admins</option></select>
                <button id="history-apply" class="bg-indigo-600 text-white py-2 px-3 rounded-lg">Apply</button>
                <button id="export-csv" class="bg-green-600 text-white py-2 px-3 rounded">Export CSV</button>
                <button id="export-json" class="bg-slate-600 text-white py-2 px-3 rounded">Export JSON</button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div class="p-4 rounded-lg bg-slate-700/50"><p class="text-slate-400">Total actions</p><p id="hist-total" class="text-2xl font-bold">0</p></div>
              <div class="p-4 rounded-lg bg-green-800/30"><p class="text-slate-400">Uploads</p><p id="hist-uploads" class="text-2xl font-bold">0</p></div>
              <div class="p-4 rounded-lg bg-red-800/30"><p class="text-slate-400">Deletes</p><p id="hist-deletes" class="text-2xl font-bold">0</p></div>
            </div>

            <div class="mb-4">
              <canvas id="hist-chart" height="120"></canvas>
            </div>

            <div id="hist-list" class="table-container overflow-y-auto">
              <table class="w-full text-left text-slate-300">
                <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">Timestamp</th><th class="p-3">Admin</th><th class="p-3">Action</th><th class="p-3">Student</th><th class="p-3">Image</th></tr></thead>
                <tbody id="hist-list-body"></tbody>
              </table>
            </div>

            <div class="flex justify-center mt-4">
              <button id="history-load-more" class="bg-indigo-600 text-white py-2 px-4 rounded">Load more</button>
            </div>
          </div>

          <!-- PAGE: STORAGE -->
          <div id="page-storage" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
            <h1 class="text-2xl text-white khmer-title mb-6">Storage & Links</h1>
            <p class="text-slate-400 mb-6">This section provides direct links to the Google Sheets and Folders used by the application.</p>
            <div id="storage-links-container" class="space-y-6"></div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profile-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
    <div class="modal-content w-full max-w-md p-6 rounded-2xl shadow-2xl text-left">
      <div class="flex items-center gap-4 mb-4">
        <img id="profile-modal-img" class="w-16 h-16 rounded-full" src="" alt="Admin" crossorigin="anonymous">
        <div>
          <h3 id="profile-modal-name" class="text-xl font-bold"></h3>
          <div id="profile-modal-role" class="text-slate-400"></div>
          <div id="profile-modal-position" class="text-slate-400 text-sm mt-1"></div>
        </div>
        <div class="ml-auto">
          <button id="profile-logout" class="text-red-400 hover:text-red-300">Logout</button>
        </div>
      </div>

      <div id="profile-actions" class="space-y-3">
        <div id="profile-admin-actions" class="hidden">
          <button id="open-admin-manager" class="w-full bg-indigo-600 text-white py-2 rounded-lg">Admin Management (Superadmin)</button>
          <button id="open-history-from-profile" class="w-full bg-slate-600 text-white py-2 rounded-lg">View History & Analytics</button>
        </div>
        <div id="profile-viewer-actions">
          <p class="text-slate-400 text-sm">You can view student images and stats as permitted by your role.</p>
        </div>
      </div>

      <div class="mt-4 text-right">
        <button id="close-profile-modal" class="w-28 bg-indigo-600 text-white py-2 rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <!-- ADMIN MANAGER MODAL -->
  <div id="admin-manager-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
    <div class="modal-content w-full max-w-3xl p-6 rounded-2xl shadow-2xl text-left">
      <h3 class="text-xl font-bold mb-4">Admin Management</h3>
      <div id="admin-manager-list" class="space-y-2 max-h-72 overflow-y-auto"></div>
      <div class="mt-4 flex gap-3">
        <button id="admin-manager-refresh" class="bg-slate-600 text-white py-2 px-4 rounded-lg">Refresh</button>
        <button id="admin-manager-close" class="bg-indigo-600 text-white py-2 px-4 rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <!-- MODAL (generic) -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
    <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center">
      <div id="modal-icon" class="w-16 h-16 mx-auto mb-4"></div>
      <p id="modal-message" class="text-lg font-semibold text-white mb-6"></p>
      <div id="modal-buttons" class="flex flex-col sm:flex-row gap-4"></div>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG
    // ============================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyM-9UZbpL8GW6agRejPVGalKcTQPIdmm5-Xa0BWnpgrJiqahHFIRSE0LKH7n15AjNQ/exec'; // <<--- REPLACE with your deployed web app URL
    const SECOND_SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
    const SECOND_SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';

    // DOM refs (essentials)
    const video = document.getElementById('video'), captureCanvas = document.getElementById('capture-canvas'),
      photoPreview = document.getElementById('photo-preview'), uploadBtn = document.getElementById('upload-btn'),
      retakeBtn = document.getElementById('retake-btn'), cameraSection = document.getElementById('camera-section'),
      videoWrapper = document.getElementById('video-wrapper'), faceStatus = document.getElementById('face-status'),
      subtitle = document.getElementById('subtitle'), switchCameraBtn = document.getElementById('switch-camera-btn'),
      backBtn = document.getElementById('back-btn'), manualCaptureBtn = document.getElementById('manual-capture-btn');

    const modal = document.getElementById('modal'), modalIcon = document.getElementById('modal-icon'),
      modalMessage = document.getElementById('modal-message'), modalButtons = document.getElementById('modal-buttons');

    const pageScan = document.getElementById('page-scan'), pageRecords = document.getElementById('page-records'),
      pageList = document.getElementById('page-list'), pageStorage = document.getElementById('page-storage'),
      pageHistory = document.getElementById('page-history');

    const navScan = document.getElementById('nav-scan'), navRecords = document.getElementById('nav-records'),
      navList = document.getElementById('nav-list'), navStorage = document.getElementById('nav-storage'),
      navHistory = document.getElementById('nav-history');

    const sidebar = document.getElementById('sidebar'), menuBtn = document.getElementById('menu-btn'),
      sidebarBackdrop = document.getElementById('sidebar-backdrop'), logoutBtn = document.getElementById('logout-btn');

    const selectionArea = document.getElementById('selection-area'), studentSearchInput = document.getElementById('student-search-input'),
      studentList = document.getElementById('student-list');

    const recordsLoading = document.getElementById('records-loading'), recordsTable = document.getElementById('records-table'),
      recordsClassFilter = document.getElementById('records-class-filter'), recordsSearchInput = document.getElementById('records-search-input');

    const listLoading = document.getElementById('list-loading'), listTable = document.getElementById('list-table'),
      listClassFilter = document.getElementById('list-class-filter'), listSearchInput = document.getElementById('list-search-input'),
      listTotalCount = document.getElementById('list-total-count'), listCompletedCount = document.getElementById('list-completed-count'),
      listPendingCount = document.getElementById('list-pending-count');

    const loginScreen = document.getElementById('login-screen'), mainAppWrapper = document.getElementById('main-app-wrapper'),
      adminListLoader = document.getElementById('admin-list-loader'), adminSelect = document.getElementById('admin-select'),
      proceedToScanBtn = document.getElementById('proceed-to-scan-btn'), adminSelectionArea = document.getElementById('admin-selection-area'),
      adminScanArea = document.getElementById('admin-scan-area'), adminVideoWrapper = document.getElementById('admin-video-wrapper'),
      adminVideo = document.getElementById('admin-video'), adminScanStatus = document.getElementById('admin-scan-status'),
      adminManualScanBtn = document.getElementById('admin-manual-scan-btn'), adminBackBtn = document.getElementById('admin-back-btn'),
      adminProfileImgHeader = document.getElementById('admin-profile-img-header'), adminProfileSidebar = document.getElementById('admin-profile-sidebar'),
      adminProfileImgSidebar = document.getElementById('admin-profile-img-sidebar'), adminNameSidebar = document.getElementById('admin-name-sidebar');

    // Profile & Admin Manager refs
    const sidebarProfileImg = document.getElementById('sidebar-profile-img');
    const sidebarProfileName = document.getElementById('sidebar-profile-name');
    const sidebarProfileRole = document.getElementById('sidebar-profile-role');

    const openProfileBtn = document.getElementById('open-profile-btn');
    const profileModal = document.getElementById('profile-modal');
    const profileModalImg = document.getElementById('profile-modal-img');
    const profileModalName = document.getElementById('profile-modal-name');
    const profileModalRole = document.getElementById('profile-modal-role');
    const profileModalPosition = document.getElementById('profile-modal-position');
    const profileLogout = document.getElementById('profile-logout');
    const profileAdminActions = document.getElementById('profile-admin-actions');

    const adminManagerModal = document.getElementById('admin-manager-modal');
    const adminManagerList = document.getElementById('admin-manager-list');
    const adminManagerRefresh = document.getElementById('admin-manager-refresh');
    const adminManagerClose = document.getElementById('admin-manager-close');

    const historyApplyBtn = document.getElementById('history-apply');
    const historyStart = document.getElementById('history-start');
    const historyEnd = document.getElementById('history-end');
    const historyAdminFilter = document.getElementById('history-admin-filter');
    const histTotal = document.getElementById('hist-total');
    const histUploads = document.getElementById('hist-uploads');
    const histDeletes = document.getElementById('hist-deletes');
    const histListBody = document.getElementById('hist-list-body');
    const histChartCtx = document.getElementById('hist-chart').getContext('2d');
    const historyLoadMoreBtn = document.getElementById('history-load-more');

    // icons & modal helper
    const icons = {
      success:`<svg class="w-full h-full text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      error:`<svg class="w-full h-full text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      loading:`<div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin"></div>`,
      confirm:`<svg class="w-full h-full text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
      choice:`<svg class="w-full h-full text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13-4-4M3 10h12M3 15h4M4 19h16a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1z"/></svg>`
    };

    // state
    let studentsData=[], savedRecordsData=[], allStudentsListData=[], adminData=[],
        currentStream, faceApiInterval, stableFrames=0, currentFacingMode='environment',
        selectedStudent=null, currentCameraMode='auto',
        loggedInAdmin=null, adminFaceMatcher=null, adminScanInterval=null, isScanning=false,
        isUploading=false;

    // session helpers
    const SESSION_KEY = 'di_admin_session_v1';
    function saveAdminSession({ name, imageUrl }) {
      try { localStorage.setItem(SESSION_KEY, JSON.stringify({ name, imageUrl, ts: Date.now() })); } catch (_) {}
    }
    function loadAdminSession() {
      try { const r = localStorage.getItem(SESSION_KEY); return r ? JSON.parse(r) : null; } catch (_) { return null; }
    }
    function clearAdminSession() { try { localStorage.removeItem(SESSION_KEY); } catch (_) {} }

    // modal helper
    function showModal(type, message, actions={}) {
      modalIcon.innerHTML = icons[type] || '';
      modalMessage.textContent = message;
      modal.classList.remove('hidden');
      modalButtons.innerHTML = '';
      if (type === 'loading') return;
      if (Object.keys(actions).length) {
        for (const [txt, action] of Object.entries(actions)) {
          const b=document.createElement('button');
          b.className=action.className||"w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700 transition";
          b.textContent=txt;
          b.onclick=()=>{ modal.classList.add('hidden'); if(action.callback) action.callback(); };
          modalButtons.appendChild(b);
        }
      } else {
        const b=document.createElement('button');
        b.className="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition";
        b.textContent="យល់ព្រម";
        b.onclick=()=>modal.classList.add('hidden');
        modalButtons.appendChild(b);
      }
    }

    // Face API model loader
    async function loadModels(){
      const MODEL_URL='./models';
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
      ]);
    }

    // ============================
    // Admin list + login (admin list from backend)
    // ============================
    async function fetchAdmins(){
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getAdmins`);
        if(!res.ok) throw new Error('Failed to fetch admins');
        const data = await res.json();
        adminData = Array.isArray(data.data) ? data.data : [];
        populateAdminSelect();
        populateHistoryAdminFilter();
      } catch (e) {
        console.warn('fetchAdmins failed:', e);
        adminListLoader.classList.add('hidden');
        adminSelect.classList.remove('hidden');
      }
    }

    function populateAdminSelect(){
      adminSelect.innerHTML = '<option value="">-- សូមជ្រើសរើសឈ្មោះ --</option>';
      adminData.forEach((a,i)=>{
        const opt=document.createElement('option');
        opt.value=i; opt.textContent=a.name;
        adminSelect.appendChild(opt);
      });
      adminListLoader.classList.add('hidden');
      adminSelect.classList.remove('hidden');
    }

    adminSelect.onchange = () => {
      proceedToScanBtn.classList.toggle('hidden', !adminSelect.value);
    };

    proceedToScanBtn.onclick = () => {
      const idx = adminSelect.value;
      if (!idx) return;
      const candidate = adminData[idx];
      if (candidate && candidate.disabled) { showModal('error','This admin account has been disabled. Contact a superadmin.'); return; }
      loggedInAdmin = [candidate.name, candidate.imageUrl];
      adminSelectionArea.classList.add('hidden');
      adminScanArea.classList.remove('hidden');
      adminScanStatus.textContent='Starting camera...';
      startAdminLoginScan(candidate);
    };

    // Create FaceMatcher from admin image
    async function createFaceMatcherForAdmin(imageUrl, label){
      try{
        const img = await faceapi.fetchImage(imageUrl);
        const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
                                .withFaceLandmarks().withFaceDescriptor();
        if(!det) return null;
        const desc = new faceapi.LabeledFaceDescriptors(label,[det.descriptor]);
        return new faceapi.FaceMatcher(desc, 0.5);
      }catch(e){
        console.error('createFaceMatcherForAdmin error', e);
        return null;
      }
    }

    // Admin login: ALWAYS use front camera
    async function startAdminLoginScan(candidate){
      adminScanStatus.textContent = `Loading reference for ${candidate.name}...`;
      adminFaceMatcher = await createFaceMatcherForAdmin(candidate.imageUrl, candidate.name);
      if(!adminFaceMatcher){
        adminScanStatus.textContent='Could not load reference image. Please go back.';
        adminVideoWrapper.classList.add('fail'); return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:640, height:480 }});
        currentStream=stream; adminVideo.srcObject=stream;
        adminVideo.onloadedmetadata=()=>{
          adminScanStatus.textContent='Look at the camera. Auto-scanning...';
          adminVideoWrapper.classList.add('ready'); startAdminScanInterval();
        };
      }catch(err){
        showModal('error','Please allow camera access.'); resetToAdminSelection();
      }
    }

    function startAdminScanInterval(){
      clearInterval(adminScanInterval); isScanning=true;
      adminScanInterval=setInterval(async()=>{
        if(!isScanning) return;
        const ok = await performAdminScan();
        if(ok) onLoginSuccess();
      }, 1000);
    }

    async function performAdminScan(){
      if(!adminFaceMatcher) return false;
      const det = await faceapi.detectSingleFace(adminVideo, new faceapi.TinyFaceDetectorOptions({inputSize:224, scoreThreshold:.5}))
                               .withFaceLandmarks().withFaceDescriptor();
      if(det){
        const best = adminFaceMatcher.findBestMatch(det.descriptor);
        if(best.label!=='unknown' && best.distance<0.5){
          adminScanStatus.textContent=`Welcome, ${best.label}!`;
          adminVideoWrapper.classList.remove('fail'); adminVideoWrapper.classList.add('ready');
          return true;
        } else {
          adminScanStatus.textContent='Face does not match. Trying...';
          adminVideoWrapper.classList.add('fail'); return false;
        }
      } else {
        adminScanStatus.textContent='No face detected. Please center your face.';
        adminVideoWrapper.classList.remove('fail'); return false;
      }
    }

    adminManualScanBtn.onclick = async ()=>{
      if(isScanning) clearInterval(adminScanInterval); isScanning=false;
      adminScanStatus.textContent='Manual scan... processing...';
      const ok = await performAdminScan();
      if(ok) onLoginSuccess(); else {
        adminScanStatus.textContent='Manual scan failed. Resuming auto-scan...';
        setTimeout(()=>{ if(!isScanning) startAdminScanInterval(); }, 2000);
      }
    };

    function resetToAdminSelection(){
      stopCamera();
      adminScanArea.classList.add('hidden');
      adminSelectionArea.classList.remove('hidden');
      adminVideoWrapper.classList.remove('ready','fail');
      adminSelect.value=""; proceedToScanBtn.classList.add('hidden');
      loggedInAdmin=null; adminFaceMatcher=null; clearInterval(adminScanInterval);
    }
    adminBackBtn.onclick = resetToAdminSelection;

    // After successful login
    async function onLoginSuccess(){
      clearInterval(adminScanInterval);
      stopCamera();

      saveAdminSession({ name: loggedInAdmin[0], imageUrl: loggedInAdmin[1] });

      adminProfileImgHeader.crossOrigin='anonymous';
      adminProfileImgSidebar.crossOrigin='anonymous';
      adminProfileImgHeader.src = loggedInAdmin[1];
      adminProfileImgSidebar.src = loggedInAdmin[1];
      adminNameSidebar.textContent = loggedInAdmin[0];
      adminProfileImgHeader.classList.remove('hidden');
      adminProfileSidebar.classList.remove('hidden');

      loginScreen.classList.add('hidden');
      if (loginScreen.parentNode) loginScreen.parentNode.removeChild(loginScreen);

      mainAppWrapper.classList.remove('hidden');

      renderProfileUI();
      await fetchStudents();
    }

    logoutBtn.onclick = (e)=>{ e.preventDefault(); clearAdminSession(); location.reload(); };
    profileLogout.onclick = (e)=>{ e.preventDefault(); clearAdminSession(); location.reload(); };

    // ============================
    // Students & Records
    // ============================
    async function fetchStudents(){
      try{
        const res = await fetch(`${SCRIPT_URL}?action=getStudents`);
        if(!res.ok) throw new Error(`Server error: ${res.status}`);
        const data = await res.json();
        studentsData = data.slice(1);
        allStudentsListData = studentsData;
        populateStudentList();
      }catch(e){ showModal('error',`Could not fetch student data: ${e.message}`); }
    }

    function populateStudentList(filter=''){
      studentList.innerHTML='';
      const f = filter.toLowerCase();
      const filtered = studentsData.filter(s => (s[0]||'').toString().toLowerCase().includes(f) || (s[1]||'').toLowerCase().includes(f));
      if(!filtered.length){ studentList.innerHTML=`<li class="text-center text-slate-400 p-4">No students found.</li>`; return; }
      filtered.forEach(s=>{
        const li=document.createElement('li');
        li.className='p-3 rounded-lg cursor-pointer transition flex justify-between items-center';
        const count=s[4];
        if(count>0) li.classList.add('completed');
        const indicator = count>0 ? `<i class="fas fa-check-circle ml-2 text-green-400"></i>` : '';
        if(count>0){
          li.style.pointerEvents='none'; li.style.opacity='.7'; li.style.color='#4ade80';
        }else{
          li.onclick=()=>{ selectedStudent=s; showCameraModeSelection(); };
        }
        li.innerHTML = `<span>${s[0]} - ${s[1]}</span>${indicator}`;
        studentList.appendChild(li);
      });
    }

    function showCameraModeSelection(){
      showModal('choice','សូមជ្រើសរើសប្រតិបត្តិកាមេរ៉ា',{
        'ថតរូបស្វ័យប្រវត្តិ':{ callback:()=>startCamera('environment','auto'), className:"w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition" },
        'ថតរូបដោយខ្លួនឯង':{ callback:()=>startCamera('environment','manual'), className:"w-full bg-slate-600 text-white py-3 rounded-lg font-semibold hover:bg-slate-700 transition" }
      });
    }

    function populateClassFilter(records, filterElement){
      const classes=[...new Set(records.map(r=>r[3]).filter(Boolean))];
      filterElement.innerHTML='<option value="all">All Classes</option>';
      classes.sort().forEach(c=>filterElement.innerHTML+=`<option value="${c}">${c}</option>`);
    }

    async function displaySavedRecords(){
      recordsLoading.style.display='block'; recordsTable.classList.add('hidden');
      try{
        const res=await fetch(`${SCRIPT_URL}?action=getSavedData`);
        if(!res.ok) throw new Error(`Server error: ${res.status}`);
        const data=await res.json();
        savedRecordsData=data.slice(1);
        populateClassFilter(savedRecordsData, recordsClassFilter);
        filterRecordsTable();
        recordsLoading.style.display='none'; recordsTable.classList.remove('hidden');
      }catch(e){ recordsLoading.innerHTML=`<p class="text-red-400">Error: ${e.message}</p>`; }
    }

    function filterRecordsTable(){
      const sel=recordsClassFilter.value, q=recordsSearchInput.value.toLowerCase();
      const tbody=recordsTable.querySelector('tbody'); tbody.innerHTML='';
      const rows=savedRecordsData.filter(r=>{
        const cOk=sel==='all'||r[3]===sel;
        const sOk=(r[1]||'').toLowerCase().includes(q)||(r[2]||'').toString().toLowerCase().includes(q);
        return cOk&&sOk;
      });
      if(!rows.length){ tbody.innerHTML=`<tr><td colspan="7" class="text-center p-4 text-slate-400">No records found.</td></tr>`; return; }
      rows.forEach(r=>{
        const serial=r[0], url=r[5];
        const tr=document.createElement('tr'); tr.className='border-b border-slate-700';
        tr.innerHTML=`
          <td class="p-3">${serial}</td>
          <td class="p-3 whitespace-nowrap">${r[1]}</td>
          <td class="p-3">${r[2]}</td>
          <td class="p-3">${r[3]}</td>
          <td class="p-3">${r[4]}</td>
          <td class="p-3">
            <a href="${url}" target="_blank" rel="noopener noreferrer" class="relative block w-16 h-16 group rounded-lg overflow-hidden">
              <img src="${url}" crossorigin="anonymous" class="w-full h-full object-cover" alt="Student photo">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center transition-opacity">
                <i class="fas fa-expand text-white text-xl opacity-0 group-hover:opacity-100 transition-opacity"></i>
              </div>
            </a>
          </td>
          <td class="p-3 text-center"><button class="text-red-400 hover:text-red-600 transition delete-btn"><i class="fas fa-trash-alt"></i></button></td>
        `;
        tr.querySelector('.delete-btn').onclick=()=>handleDelete(serial,url);
        tbody.appendChild(tr);
      });
    }

    async function handleDelete(serialNumber, imageUrl){
      // server-side permission enforced; frontend only shows modal and sends adminName
      showModal('confirm','តើអ្នកប្រាកដទេថាចង់លុបរូបភាពនេះ?',{
        'Cancel':{ callback:null, className:"w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700 transition" },
        'Delete':{ callback:async()=>{
          showModal('loading','កំពុងលុប...');
          try{
            const res=await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({action:'delete', serialNumber, imageUrl, adminName: loggedInAdmin ? loggedInAdmin[0] : ''}), redirect:'follow' });
            if(!res.ok) throw new Error(`Server error: ${res.status}`);
            const r=await res.json();
            if(r.status==='success'){
              showModal('success',"រូបភាពត្រូវបានលុប!",{ 'OK':{ callback:async()=>{ await fetchStudents(); await displaySavedRecords(); populateStudentList(); } }});
            }else throw new Error(r.message||"Unknown server error.");
          }catch(e){ showModal('error',`Delete failed: ${e.message}`); }
        }, className:"w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition" }
      });
    }

    function populateListClassFilterV2(){
      const classes=[...new Set(allStudentsListData.map(s=>s[2]).filter(Boolean))];
      listClassFilter.innerHTML='<option value="all">All Students</option><option value="with_photos">With Photos</option>';
      classes.sort().forEach(c=>listClassFilter.innerHTML+=`<option value="${c}">${c}</option>`);
    }

    function filterStudentListTable(){
      const sel=listClassFilter.value, q=listSearchInput.value.toLowerCase();
      const tbody=listTable.querySelector('tbody'); tbody.innerHTML='';
      const imgMap=new Map(savedRecordsData.map(r=>[r[2], r[5]]));
      let arr = sel==='all' ? allStudentsListData : sel==='with_photos' ? allStudentsListData.filter(s=>s[4]>0) : allStudentsListData.filter(s=>s[2]===sel);
      arr = arr.filter(s => (s[0]||'').toString().toLowerCase().includes(q) || (s[1]||'').toLowerCase().includes(q));
      const done = arr.filter(s=>s[4]>0).length;

      if(!arr.length){
        tbody.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-slate-400">No students found.</td></tr>`;
      }else{
        arr.forEach(s=>{
          const ok=s[4]>0; const url=ok?imgMap.get(String(s[0])):null;
          const cell=url?`<a href="${url}" target="_blank" rel="noopener noreferrer" class="relative block w-12 h-12 group rounded-lg overflow-hidden mx-auto"><img src="${url}" crossorigin="anonymous" class="w-full h-full object-cover" alt="Student photo"></a>`:`<span class="text-slate-500">-</span>`;
          const icon=ok?`<i class="fas fa-check-circle text-green-400"></i>`:`<i class="fas fa-times-circle text-red-400"></i>`;
          tbody.insertAdjacentHTML('beforeend', `<tr class="border-b border-slate-700"><td class="p-3">${s[0]}</td><td class="p-3 whitespace-nowrap">${s[1]}</td><td class="p-3">${cell}</td><td class="p-3 text-center">${icon}</td></tr>`);
        });
      }
      listTotalCount.textContent=arr.length;
      listCompletedCount.textContent=done;
      listPendingCount.textContent=arr.length-done;
    }

    // ============================
    // Camera & Capture (scan page uses back camera by default)
    // ============================
    const DEFAULT_FACING = 'environment'; // scan page default: back camera
    async function startCamera(facingMode='environment', mode='auto'){
      currentFacingMode=facingMode; currentCameraMode=mode;
      stableFrames = 0;
      subtitle.textContent = `Scanning for: ${selectedStudent[1]}`;
      cameraSection.classList.remove('hidden'); selectionArea.classList.add('hidden');
      switchCameraBtn.classList.remove('hidden'); backBtn.classList.remove('hidden');
      uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden'); photoPreview.classList.add('hidden');
      videoWrapper.classList.remove('hidden');
      faceStatus.classList.remove('hidden');
      isUploading = false;

      stopCamera();
      try{
        const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode, width:{ideal:640}, height:{ideal:480} }, audio:false });
        currentStream=stream; video.srcObject=stream;
        video.onloadedmetadata=()=>{
          if(mode==='auto'){ manualCaptureBtn.classList.add('hidden'); detectFace(); }
          else { manualCaptureBtn.classList.remove('hidden'); faceStatus.textContent="ចុចប៊ូតុងកាមេរ៉ាដើម្បីថត"; faceStatus.classList.remove('text-green-400'); videoWrapper.classList.remove('ready'); }
        };
      }catch(err){ showModal('error','Please allow camera access.'); resetToSelection(); }
    }

    async function detectFace(){
      const opts=new faceapi.TinyFaceDetectorOptions({inputSize:224, scoreThreshold:.5});
      clearInterval(faceApiInterval);
      faceApiInterval=setInterval(async()=>{
        const res=await faceapi.detectSingleFace(video,opts);
        if(res && res.score>0.7){
          stableFrames++; faceStatus.textContent=`Excellent! (${stableFrames}/4)`; faceStatus.classList.add('text-green-400'); videoWrapper.classList.add('ready');
          if(stableFrames>=4) captureFace();
        }else{
          stableFrames=0; faceStatus.textContent="Please center your face"; faceStatus.classList.remove('text-green-400'); videoWrapper.classList.remove('ready');
        }
      },400);
    }

    function captureFace(){
      clearInterval(faceApiInterval);
      const ctx=captureCanvas.getContext('2d'); const size=512;
      captureCanvas.width=size; captureCanvas.height=size;
      // Do NOT mirror (no translate/scale)
      const vRatio=video.videoWidth/video.videoHeight;
      let sx=0, sy=0, sw=video.videoWidth, sh=video.videoHeight;
      if(vRatio>1){ sw=sh; sx=(video.videoWidth-sw)/2; } else { sh=sw; sy=(video.videoHeight-sh)/2; }
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,size,size);
      photoPreview.src=captureCanvas.toDataURL('image/jpeg', .9);
      stopCamera();
      switchCameraBtn.classList.add('hidden'); videoWrapper.classList.add('hidden'); manualCaptureBtn.classList.add('hidden');
      photoPreview.classList.remove('hidden'); uploadBtn.classList.remove('hidden'); retakeBtn.classList.remove('hidden'); faceStatus.classList.add('hidden');
      subtitle.textContent="Confirm your photo";
    }

    function stopCamera(){ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); clearInterval(faceApiInterval); clearInterval(adminScanInterval); }

    function resetToSelection(){
      stopCamera();
      cameraSection.classList.add('hidden'); switchCameraBtn.classList.add('hidden'); manualCaptureBtn.classList.add('hidden');
      backBtn.classList.add('hidden'); photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden');
      videoWrapper.classList.remove('hidden'); selectionArea.classList.remove('hidden'); subtitle.textContent="Select your ID or Name"; selectedStudent=null;
    }

    manualCaptureBtn.onclick = captureFace;

    // upload sends adminName to backend
    uploadBtn.onclick = async ()=>{
      if(isUploading) return;
      if(!selectedStudent){ showModal('error','Could not find student data.'); return; }
      // check role on client to show nicer UX; actual permission enforced server-side
      const currAdmin = adminData.find(a => a.name === (loggedInAdmin ? loggedInAdmin[0] : ''));
      if (currAdmin && currAdmin.role === 'viewer') { showModal('error','Permission denied: viewer cannot upload'); return; }

      const imageData=captureCanvas.toDataURL('image/jpeg', .9).split(',')[1];
      showModal('loading','កំពុងបញ្ជូនរូបភាព...');
      isUploading = true;
      try{
        const res=await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({ id:selectedStudent[0], name:selectedStudent[1], class:selectedStudent[2], group:selectedStudent[3], imageData, adminName: loggedInAdmin?loggedInAdmin[0]:'' }), redirect:'follow' });
        if(!res.ok) throw new Error(`Server error: ${res.status}`);
        const r=await res.json();
        if(r.status==='success'){
          // ensure secondary sheet AA/AJ updated; backend already does this in createRecord, but we fire a writeSecondaryLink for UI immediacy (optional)
          try {
            await fetch(SCRIPT_URL,{ method:'POST', body:JSON.stringify({ action:'writeSecondaryLink', spreadsheetId: SECOND_SHEET_ID, sheetName: SECOND_SHEET_NAME, id: selectedStudent[0], imageUrl: r.imageUrl })});
          } catch(e){}
          showModal('success',"រូបភាពរក្សាទុកបានជោគជ័យ!",{ 'OK':{ callback:async()=>{ resetToSelection(); await fetchStudents(); } }});
        } else throw new Error(r.message||"Unknown server error.");
      }catch(e){ showModal('error',`Upload failed: ${e.message}`); }
      finally { isUploading = false; }
    };

    retakeBtn.onclick = ()=>{ photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden'); videoWrapper.classList.remove('hidden'); faceStatus.classList.remove('hidden'); stableFrames=0; startCamera(currentFacingMode,currentCameraMode); };
    switchCameraBtn.onclick = ()=> startCamera(currentFacingMode==='user' ? 'environment' : 'user', currentCameraMode);
    backBtn.onclick = ()=> resetToSelection();
    studentSearchInput.oninput = ()=> populateStudentList(studentSearchInput.value);

    // ============================
    // Storage links
    // ============================
    function populateStorageLinks() {
      const container = document.getElementById('storage-links-container');
      const links = {
        'Sheets': {
          'Student List (DIList)': 'https://docs.google.com/spreadsheets/d/1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc/edit',
          'Saved Info & Admins (InfoUsers)': 'https://docs.google.com/spreadsheets/d/1dleEg_Q5KV9IRGT4DpfHooZQ_p2bKLk-2yCGYootqPA/edit',
          'Secondary List (បញ្ជឺឈ្មោះរួម)': 'https://docs.google.com/spreadsheets/d/1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc/edit'
        },
        'Folders': {
          'Default Uploads': 'https://drive.google.com/drive/folders/10RyejYi9_J0c7gxrL5wgmODy4VfJZ6SA',
          'AD Class': 'https://drive.google.com/drive/folders/140JXHUU9FIKB7VNEXUsv9rPJ4i8S_SMY'
        }
      };
      container.innerHTML = '';
      for (const [category, items] of Object.entries(links)) {
        let html = `<div class="mb-6"><h3 class="text-xl font-semibold text-indigo-300 mb-3">${category}</h3><div class="space-y-2">`;
        for (const [title, url] of Object.entries(items)) {
          html += `
            <a href="${url}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg hover:bg-slate-600/50 transition">
              <span class="font-medium">${title}</span>
              <i class="fas fa-external-link-alt text-slate-400"></i>
            </a>`;
        }
        html += `</div></div>`;
        container.innerHTML += html;
      }
    }

    // ============================
    // Navigation wiring
    // ============================
    const closeSidebar = () => { sidebar.classList.remove('is-open'); sidebarBackdrop.classList.add('hidden'); };
    const navLinks = [navScan, navList, navRecords, navHistory, navStorage];
    const pages = [pageScan, pageList, pageRecords, pageHistory, pageStorage];

    navLinks.forEach((link, index) => {
      link.onclick = (e) => {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove('active'));
        pages.forEach(p => p.classList.add('hidden'));
        link.classList.add('active');
        pages[index].classList.remove('hidden');
        stopCamera();
        if (pages[index] === pageRecords) displaySavedRecords();
        if (pages[index] === pageList) displayStudentList();
        if (pages[index] === pageStorage) populateStorageLinks();
        if (pages[index] === pageHistory) { histPage = 1; loadHistoryPage(true); }
        closeSidebar();
      }
    });
    menuBtn.onclick = () => { sidebar.classList.toggle('is-open'); sidebarBackdrop.classList.toggle('hidden'); };
    sidebarBackdrop.onclick = () => closeSidebar();

    recordsClassFilter.onchange = () => filterRecordsTable();
    listClassFilter.onchange = () => filterStudentListTable();
    recordsSearchInput.oninput = () => filterRecordsTable();
    listSearchInput.oninput = () => filterStudentListTable();

    // ============================
    // Profile & Admin Manager UI
    // ============================
    function renderProfileUI() {
      if (!loggedInAdmin) return;
      sidebarProfileImg.src = loggedInAdmin[1];
      sidebarProfileName.textContent = loggedInAdmin[0];
      const a = adminData.find(x => x.name === loggedInAdmin[0]);
      const role = a && a.role ? a.role : (a ? a.role : 'admin');
      sidebarProfileRole.textContent = `Role: ${role}`;
      profileModalImg.src = loggedInAdmin[1];
      profileModalName.textContent = loggedInAdmin[0];
      profileModalRole.textContent = `Role: ${role}`;
      profileModalPosition.textContent = a && a.position ? a.position : '';
      if (role === 'superadmin') profileAdminActions.classList.remove('hidden'); else profileAdminActions.classList.add('hidden');
    }

    openProfileBtn.onclick = () => { profileModal.classList.remove('hidden'); renderProfileUI(); };
    document.getElementById('close-profile-modal').onclick = () => profileModal.classList.add('hidden');

    document.getElementById('open-admin-manager').onclick = async () => {
      profileModal.classList.add('hidden');
      adminManagerModal.classList.remove('hidden');
      await loadAdminManagerList();
    };

    adminManagerRefresh.onclick = loadAdminManagerList;
    adminManagerClose.onclick = () => adminManagerModal.classList.add('hidden');

    async function loadAdminManagerList(){
      adminManagerList.innerHTML = '<div class="p-4 text-slate-400">Loading admins...</div>';
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getAdmins`);
        const json = await res.json();
        const adata = Array.isArray(json.data) ? json.data : [];
        adminManagerList.innerHTML = '';
        for (let i = 0; i < adata.length; i++){
          const item = adata[i];
          const name = item.name;
          const imageUrl = item.imageUrl;
          const role = item.role || 'admin';
          const disabled = item.disabled === true;
          const card = document.createElement('div');
          card.className = 'flex items-center gap-3 p-3 bg-slate-700/40 rounded-lg';
          card.innerHTML = `
            <img src="${imageUrl}" class="w-12 h-12 rounded-full" crossorigin="anonymous">
            <div class="flex-1">
              <div class="font-semibold">${name}</div>
              <div class="text-sm text-slate-400 mb-2">role: <span class="admin-role">${role}</span> ${disabled ? ' (disabled)' : ''}</div>
              <div class="flex gap-2 items-center">
                <select class="filter-select admin-role-select">
                  <option value="superadmin">Superadmin</option>
                  <option value="admin">Admin</option>
                  <option value="subadmin">Subadmin</option>
                  <option value="viewer">Viewer</option>
                </select>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="admin-disabled"> Disabled</label>
                <button class="bg-red-600 text-white py-1 px-2 rounded ml-auto admin-update-btn">Save</button>
              </div>
            </div>
          `;
          const select = card.querySelector('.admin-role-select');
          select.value = role;
          const chk = card.querySelector('.admin-disabled');
          chk.checked = disabled;
          const updateBtn = card.querySelector('.admin-update-btn');
          updateBtn.onclick = async () => {
            if (!confirm(`Save changes for ${name} (role=${select.value}, disabled=${chk.checked})?`)) return;
            const payload = { action: 'setAdminRole', name, role: select.value, disabled: chk.checked, requestedBy: loggedInAdmin ? loggedInAdmin[0] : '' };
            try {
              const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
              const jr = await r.json();
              if (jr.status === 'success') {
                card.querySelector('.admin-role').textContent = select.value;
                alert('Updated');
                await fetchAdmins();
              } else {
                alert('Update failed: ' + jr.message);
              }
            } catch (e) { alert('Update error: ' + e.message); }
          };
          adminManagerList.appendChild(card);
        }
        // enable sortable visual reorder
        new Sortable(adminManagerList, { animation: 150, ghostClass: 'bg-slate-600/40' });
      } catch (e) {
        adminManagerList.innerHTML = `<div class="p-4 text-red-400">Error loading admins: ${e.message}</div>`;
      }
    }

    // ============================
    // History & Analytics: pagination, chart, exports
    // ============================
    let histChart = null;
    let histPage = 1, histPageSize = 50, histLoading = false;

    function populateHistoryAdminFilter(){
      historyAdminFilter.innerHTML = '<option value="all">All Admins</option>';
      (adminData || []).forEach(a => {
        historyAdminFilter.innerHTML += `<option value="${a.name}">${a.name}</option>`;
      });
    }

    async function loadHistoryPage(reset=false) {
      if (histLoading) return;
      histLoading = true;
      if (reset) { histPage = 1; histListBody.innerHTML = ''; }
      const s = historyStart.value ? historyStart.value : '';
      const e = historyEnd.value ? historyEnd.value : '';
      const adminName = historyAdminFilter.value === 'all' ? '' : historyAdminFilter.value;
      const q = `${SCRIPT_URL}?action=getAdminActions&page=${histPage}&pageSize=${histPageSize}${s? '&start='+encodeURIComponent(s):''}${e? '&end='+encodeURIComponent(e):''}${adminName? '&admin='+encodeURIComponent(adminName):''}`;
      try {
        const res = await fetch(q);
        const jr = await res.json();
        (jr.rows || []).forEach(r => {
          const tr = document.createElement('tr'); tr.className = 'border-b border-slate-700';
          tr.innerHTML = `<td class="p-3">${new Date(r.timestamp).toLocaleString()}</td><td class="p-3">${r.admin}</td><td class="p-3">${r.action}</td><td class="p-3">${r.studentName} (${r.studentId})</td><td class="p-3"><a href="${r.imageUrl}" target="_blank">View</a></td>`;
          histListBody.appendChild(tr);
        });
        histTotal.textContent = jr.total || 0;
        histUploads.textContent = Object.values(jr.byAdmin || {}).reduce((a,b)=>a+(b.uploads||0),0) || 0;
        histDeletes.textContent = Object.values(jr.byAdmin || {}).reduce((a,b)=>a+(b.deletes||0),0) || 0;
        if ((histPage * histPageSize) >= (jr.total || 0)) historyLoadMoreBtn.style.display='none'; else historyLoadMoreBtn.style.display='inline-block';
        // update chart
        const byDay = jr.byDay || {};
        const labels = Object.keys(byDay).sort();
        const uploads = labels.map(d => byDay[d].uploads || 0);
        const deletes = labels.map(d => byDay[d].deletes || 0);
        if (histChart) histChart.destroy();
        histChart = new Chart(histChartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Uploads', data: uploads },
              { label: 'Deletes', data: deletes }
            ]
          },
          options: { responsive:true, scales:{ x:{ stacked:false }, y:{ stacked:false } } }
        });
        histPage++;
        histLoading=false;
      } catch (e) { histLoading=false; showModal('error','Failed loading history: ' + e.message); }
    }

    historyLoadMoreBtn.onclick = ()=> loadHistoryPage(false);
    historyApplyBtn.onclick = ()=> { histPage=1; loadHistoryPage(true); };

    document.getElementById('export-csv').onclick = () => {
      const s = historyStart.value ? historyStart.value : '';
      const e = historyEnd.value ? historyEnd.value : '';
      const adminName = historyAdminFilter.value === 'all' ? '' : historyAdminFilter.value;
      const url = `${SCRIPT_URL}?action=exportAdminActions&format=csv${s? '&start='+encodeURIComponent(s):''}${e? '&end='+encodeURIComponent(e):''}${adminName? '&admin='+encodeURIComponent(adminName):''}`;
      window.open(url, '_blank');
    };
    document.getElementById('export-json').onclick = () => {
      const s = historyStart.value ? historyStart.value : '';
      const e = historyEnd.value ? historyEnd.value : '';
      const adminName = historyAdminFilter.value === 'all' ? '' : historyAdminFilter.value;
      const url = `${SCRIPT_URL}?action=exportAdminActions&format=json${s? '&start='+encodeURIComponent(s):''}${e? '&end='+encodeURIComponent(e):''}${adminName? '&admin='+encodeURIComponent(adminName):''}`;
      window.open(url, '_blank');
    };

    // ============================
    // Initial load & session
    // ============================
    window.onload = async ()=>{
      document.body.insertAdjacentHTML('afterbegin', `
        <div id="initial-loading" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 z-50">
          <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="w-24 h-24 rounded-full mb-4 shadow-lg">
          <p class="text-slate-300 text-lg">កំពុងទាញវិភាគផ្ទៃមុខ...</p>
        </div>`);
      await loadModels();
      const session = loadAdminSession();
      try { await fetchAdmins(); } catch (e) { console.warn('fetchAdmins failed:', e); }
      if (session && session.name && session.imageUrl) {
        loggedInAdmin = [session.name, session.imageUrl];
        adminProfileImgHeader.crossOrigin='anonymous';
        adminProfileImgSidebar.crossOrigin='anonymous';
        adminProfileImgHeader.src = session.imageUrl;
        adminProfileImgSidebar.src = session.imageUrl;
        adminNameSidebar.textContent = session.name;
        adminProfileImgHeader.classList.remove('hidden');
        adminProfileSidebar.classList.remove('hidden');
        loginScreen.classList.add('hidden');
        if (loginScreen.parentNode) loginScreen.parentNode.removeChild(loginScreen);
        mainAppWrapper.classList.remove('hidden');
        renderProfileUI();
        await fetchStudents();
      }
      document.getElementById('initial-loading').style.display='none';
    };
  </script>
</body>
</html>
